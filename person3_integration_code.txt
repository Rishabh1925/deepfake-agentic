
# ============================================
# INTEGRATION CODE FOR PERSON 1 (PRANAY)
# Add this to your agent system
# ============================================

# In src/agent/nodes.py, add these imports:
from person_3 import load_ll_model, load_tm_model
import torch.nn.functional as F

# Add this function to select Person 3's models:
def select_person3_specialist(metadata: dict) -> str:
    """Select between LL-Model and TM-Model based on video characteristics"""
    brightness = metadata.get('avg_brightness', 128)
    
    if brightness < 50:  # Dark video
        return 'll_model'
    else:
        return 'tm_model'

# Modify the domain_inference_node function:
def domain_inference_node(state: AgentState) -> AgentState:
    """Run specialist model inference"""
    specialist = select_specialist(state['metadata'])
    
    # Check if it's a Person 3 model
    if specialist in ['ll_model', 'tm_model']:
        return person3_inference_node(state, specialist)
    else:
        # Handle other specialists (Person 2, Person 4)
        return original_domain_inference_node(state)

def person3_inference_node(state: AgentState, model_type: str) -> AgentState:
    """Handle Person 3's LL-Model and TM-Model inference"""
    device = 'cuda' if torch.cuda.is_available() else 'cpu'
    
    if model_type == 'll_model':
        model = load_ll_model("ll_model_student (1).pt", device)
        max_frames = 10
    else:  # tm_model
        model = load_tm_model("tm_model_student.pt", device)
        max_frames = 15
    
    # Use existing face extraction from state
    frames = torch.stack(state['frames'][:max_frames]).to(device)
    
    with torch.no_grad():
        logits = model(frames.unsqueeze(0))
        probs = F.softmax(logits, dim=1)
        prediction = probs[0, 1].item()
    
    confidence = prediction if prediction > 0.5 else 1 - prediction
    
    state['specialist_prediction'] = prediction
    state['specialist_confidence'] = confidence
    state['selected_specialist'] = f'Person3_{model_type}'
    
    print(f'[PERSON3] {model_type}: Prediction: {prediction:.3f}, Confidence: {confidence:.3f}')
    
    return state
